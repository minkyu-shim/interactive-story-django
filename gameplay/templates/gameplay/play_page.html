<!DOCTYPE html>
<html>
<head>
    <title>Playing Story</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.7;
            color: #3f3e53; /* Darker, soft text color */
            background-color: #f7f7f9; /* Very light, almost white background */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 30px;
            box-sizing: border-box;
        }
        .story-container {
            background: rgba(255, 255, 255, 0.95); /* Slightly translucent white */
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            max-width: 850px;
            width: 100%;
            padding: 40px;
            box-sizing: border-box;
            border: 1px solid #e0e0e0; /* Subtle border */
        }
        h2 {
            font-family: 'Playfair Display', serif;
            color: #5d5c7c; /* Elegant header color */
            text-align: center;
            margin-bottom: 35px;
            font-size: 2.4em;
            letter-spacing: 0.05em;
        }
        .dialogue-box, .story-text {
            background: linear-gradient(135deg, rgba(250, 250, 250, 0.8), rgba(245, 245, 245, 0.8)); /* Soft gradient background */
            border: 1px solid #e8e8e8; /* Subtle border */
            padding: 20px 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            font-size: 1.15em;
            color: #4a4a60;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); /* Very light shadow */
        }
        .illustration-frame {
            margin-bottom: 22px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e3e7f2;
            background: #f5f8ff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        .illustration-frame img {
            display: block;
            width: 100%;
            max-height: 420px;
            object-fit: cover;
        }
        .dialogue-box strong {
            color: #6a68a6; /* Softer color for speaker names */
            font-weight: 700;
        }
        .ending-box {
            border: 2px dashed #9bc5e0; /* Softer, dashed border */
            background-color: #eef7fc; /* Light blueish background */
            padding: 50px;
            text-align: center;
            border-radius: 15px;
            margin-top: 40px;
        }
        .ending-box h1 {
            font-family: 'Playfair Display', serif;
            color: #6a8bb5; /* Elegant blue for ending title */
            font-size: 3.5em;
            margin-bottom: 25px;
        }
        .ending-text p {
            font-size: 1.2em;
            color: #5e5e7a;
            margin-bottom: 15px;
        }
        .ending-outcome {
            color: #7b9ccf;
            font-weight: 700;
            font-size: 1.15em;
            margin-top: 15px;
            margin-bottom: 35px;
        }
        .btn {
            display: inline-block;
            padding: 14px 30px;
            background: linear-gradient(45deg, #a7bfe8, #619af3); /* Gradient for buttons */
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-size: 1.1em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background: linear-gradient(45deg, #619af3, #a7bfe8);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .choice-btn {
            display: block;
            background: #f0f4f7; /* Light background for choices */
            color: #4a4a60;
            margin: 12px 0;
            width: 100%;
            text-align: left;
            padding: 18px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            border: 1px solid #e0e6eb;
            text-decoration: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            cursor: pointer;
            font-family: inherit;
        }
        .choice-btn:hover {
            background: #e6edf2;
            border-color: #d0d7dd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .choice-form {
            margin: 0;
        }
        .choice-roll {
            display: inline-block;
            margin-top: 6px;
            font-size: 0.82em;
            color: #8a4f00;
            background: #fff4da;
            border: 1px solid #f4d28b;
            border-radius: 999px;
            padding: 2px 8px;
        }
        .flash-message {
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .flash-message.success {
            background: #eaf8ef;
            border: 1px solid #b8e0c4;
            color: #246b38;
        }
        .flash-message.warning {
            background: #fff6e6;
            border: 1px solid #f0d39d;
            color: #8a5a00;
        }
        .flash-message.error {
            background: #fdecec;
            border: 1px solid #efb3b3;
            color: #9b1c1c;
        }
        .choice-effect {
            font-size: 0.9em;
            color: #7a7a90;
            margin-left: 10px;
            font-style: italic;
        }
        hr {
            border: none;
            border-top: 2px solid #e9e9ee; /* Thicker, softer divider */
            margin: 40px 0;
        }
        .choices h3 {
            color: #5d5c7c;
            margin-bottom: 25px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    {% if is_preview %}
        <div style="background: #fff3e0; color: #ef6c00; text-align: center; padding: 10px; font-weight: bold; border-bottom: 2px solid #ef6c00; width: 100%; position: fixed; top: 0; left: 0; z-index: 1000;">
            PREVIEW MODE: This is a draft story. Statistics will not be recorded.
        </div>
        <div style="height: 40px;"></div>
    {% endif %}
    <div class="story-container">
        {% if user.is_authenticated %}
            <div style="text-align: right; margin-bottom: 10px;">
                <a href="{% url 'report_story' story_id %}" class="btn" style="background: #e67e22; margin-top: 0;">Report Story</a>
            </div>
        {% endif %}
        {% if messages %}
            <div style="margin-bottom: 10px;">
                {% for message in messages %}
                    <div class="flash-message {{ message.tags|default:'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <h2>{{ node.title }}</h2>

        {% if node.illustration_url %}
            <div class="illustration-frame" id="node-illustration-frame">
                <img
                    src="{{ node.illustration_url }}"
                    alt="Scene illustration"
                    loading="lazy"
                    onerror="var frame=document.getElementById('node-illustration-frame'); if(frame){frame.style.display='none';}"
                >
            </div>
        {% endif %}

        {% if is_ending %}

            <div class="ending-box">
                <h1>{{ node.ending_label|default:"THE END" }}</h1>

                <div class="ending-text">
                    {% for line in node.content %}
                        <p>{{ line.text }}</p>
                    {% empty %}
                        <p>{{ node.text }}</p>
                    {% endfor %}
                </div>

                {% if node.outcome %}
                    <div class="ending-outcome">Result: {{ node.outcome }}</div>
                {% endif %}

                <a href="{% url 'story_list' %}" class="btn">Back to Menu</a>
            </div>

            <hr>

            <div class="ratings-comments">
                <h3>Ratings & Comments</h3>
                
                {% if user.is_authenticated %}
                    <div class="rating-form">
                        <h4>Leave your feedback</h4>
                        <form method="post" action="{% url 'submit_rating_comment' story_id=story_id %}" id="rating-form">
                            {% csrf_token %}
                            <div class="star-rating" id="star-selector">
                                <span class="star" data-value="1">&#9733;</span>
                                <span class="star" data-value="2">&#9733;</span>
                                <span class="star" data-value="3">&#9733;</span>
                                <span class="star" data-value="4">&#9733;</span>
                                <span class="star" data-value="5">&#9733;</span>
                            </div>
                            {{ user_rating_form.rating }}
                            <div class="comment-area">
                                {{ user_rating_form.comment }}
                            </div>
                            <button type="submit" class="btn">Submit Rating</button>
                        </form>
                    </div>
                {% else %}
                    <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to leave a rating and comment.</p>
                {% endif %}

                <div class="existing-comments">
                    <h4>What others said:</h4>
                    {% for item in ratings_comments %}
                        <div class="comment-item">
                            <div class="comment-header">
                                <strong>{{ item.user.username }}</strong> 
                                <span class="stars-display">
                                    {% for i in "12345" %}
                                        <span class="{% if forloop.counter <= item.rating %}filled{% endif %}">&#9733;</span>
                                    {% endfor %}
                                </span>
                                <small>{{ item.created_at|date:"F j, Y" }}</small>
                            </div>
                            <div class="comment-text">
                                {{ item.comment }}
                            </div>
                        </div>
                    {% empty %}
                        <p>No comments yet. Be the first to share your thoughts!</p>
                    {% endfor %}
                </div>
            </div>

            <style>
                .ratings-comments {
                    margin-top: 40px;
                }
                .rating-form {
                    background: #ffffff;
                    padding: 25px;
                    border-radius: 12px;
                    margin-bottom: 30px;
                    border: 1px solid #e0e0e0;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                }
                .star-rating {
                    font-size: 2em;
                    cursor: pointer;
                    margin-bottom: 15px;
                    display: inline-block;
                }
                .star-rating .star {
                    color: #ddd;
                    transition: color 0.2s;
                }
                .star-rating .star.hover,
                .star-rating .star.selected {
                    color: #f39c12;
                }
                .stars-display {
                    color: #ddd;
                    margin: 0 10px;
                }
                .stars-display .filled {
                    color: #f39c12;
                }
                .comment-area textarea {
                    width: 100%;
                    border-radius: 8px;
                    border: 1px solid #e0e0e0;
                    padding: 15px;
                    font-family: inherit;
                    box-sizing: border-box;
                    margin: 10px 0;
                    font-size: 1em;
                    resize: vertical;
                }
                .comment-item {
                    border-bottom: 1px solid #eee;
                    padding: 20px 0;
                }
                .comment-header {
                    margin-bottom: 8px;
                    display: flex;
                    align-items: center;
                }
                .comment-header small {
                    color: #888;
                    margin-left: auto;
                }
                .comment-text {
                    color: #4a4a60;
                    line-height: 1.5;
                }
            </style>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const stars = document.querySelectorAll('#star-selector .star');
                    const ratingInput = document.querySelector('input[name="rating"]');
                    let currentRating = parseInt(ratingInput.value) || 0;

                    function updateStars(val, type) {
                        stars.forEach(s => {
                            const starVal = parseInt(s.getAttribute('data-value'));
                            if (type === 'hover') {
                                s.classList.toggle('hover', starVal <= val);
                            } else if (type === 'select') {
                                s.classList.toggle('selected', starVal <= val);
                            }
                        });
                    }

                    // Initialize
                    if (currentRating > 0) {
                        updateStars(currentRating, 'select');
                    }

                    stars.forEach(star => {
                        star.addEventListener('mouseover', () => updateStars(parseInt(star.getAttribute('data-value')), 'hover'));
                        star.addEventListener('mouseout', () => updateStars(0, 'hover'));
                        star.addEventListener('click', () => {
                            currentRating = parseInt(star.getAttribute('data-value'));
                            ratingInput.value = currentRating;
                            updateStars(currentRating, 'select');
                        });
                    });
                });
            </script>

        {% else %}

            {% if node.text and node.type != 'dialogue' and not node.content %}
                <div class="story-text">
                    {{ node.text }}
                </div>
            {% endif %}

            {% if node.dialogue %}
                {% for line in node.dialogue %}
                    <div class="dialogue-box">
                        {% if line.speaker %}<strong>{{ line.speaker }}:</strong>{% endif %}
                        {{ line.text }}
                    </div>
                {% endfor %}
            {% endif %}

            {% for line in node.content %}
                 <div class="dialogue-box">
                    {% if line.speaker %}<strong>{{ line.speaker }}:</strong>{% endif %}
                    {{ line.text }}
                </div>
            {% endfor %}

            <hr>

            <div class="choices">
                <h3>What do you want to do?</h3>
                {% for choice in node.choices %}
                    {% if choice.id %}
                        <form method="post" action="{% url 'choose_choice' story_id=story_id node_id=node.id %}" class="choice-form">
                            {% csrf_token %}
                            <input type="hidden" name="choice_id" value="{{ choice.id }}">
                            <button type="submit" class="choice-btn">
                                <div>{{ choice.label }}</div>
                                {% if choice.requires_roll %}
                                    <span class="choice-roll">Dice 1d{{ choice.roll_sides|default:6 }} >= {{ choice.roll_required|default:4 }}</span>
                                {% endif %}
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'play_node' story_id=story_id node_id=choice.target_node %}" class="choice-btn">
                            {{ choice.label }}
                        </a>
                    {% endif %}
                {% endfor %}
            </div>

        {% endif %}
    </div>
</body>
</html>
