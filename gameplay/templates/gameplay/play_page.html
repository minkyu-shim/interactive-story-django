{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Playing Story</title>
    <link rel="stylesheet" href="{% static 'gameplay/css/app.css' %}">
    <link rel="stylesheet" href="{% static 'gameplay/css/theme.css' %}">
    <script src="{% static 'gameplay/js/theme.js' %}"></script>
</head>
<body class="app-body play-page">
    {% if is_preview %}
        <div class="preview-banner">
            PREVIEW MODE: This is a draft story. Statistics will not be recorded.
        </div>
        <div class="preview-spacer"></div>
    {% endif %}

    <div class="page-wrap">
        <div class="story-container">
            {% if user.is_authenticated %}
                <div class="report-row">
                    <a href="{% url 'report_story' story_id %}" class="btn btn-warning">Report Story</a>
                </div>
            {% endif %}

            {% if messages %}
                <div class="message-stack">
                    {% for message in messages %}
                        <div class="flash-message {{ message.tags|default:'success' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <h2 class="story-heading">{{ node.title }}</h2>
            <div class="player-meta">
                Playing as: <strong>{{ player_name }}</strong>
            </div>

            {% if node.illustration_url %}
                <div class="illustration-frame" id="node-illustration-frame">
                    <img
                        src="{{ node.illustration_url }}"
                        alt="Scene illustration"
                        loading="lazy"
                        onerror="var frame=document.getElementById('node-illustration-frame'); if(frame){frame.style.display='none';}"
                    >
                </div>
            {% endif %}

            {% if is_ending %}

                <div class="ending-box">
                    <h1>{{ node.ending_label|default:"THE END" }}</h1>

                    <div class="ending-text">
                        {% for line in node.content %}
                            <p>{{ line.text }}</p>
                        {% empty %}
                            <p>{{ node.text }}</p>
                        {% endfor %}
                    </div>

                    {% if node.outcome %}
                        <div class="ending-outcome">Result: {{ node.outcome }}</div>
                    {% endif %}

                    <a href="{% url 'story_list' %}" class="btn">Back to Menu</a>
                </div>

                <hr class="divider">

                <div class="ratings-comments">
                    <h3>Ratings & Comments</h3>

                    {% if user.is_authenticated %}
                        <div class="rating-form">
                            <h4>Leave your feedback</h4>
                            <form method="post" action="{% url 'submit_rating_comment' story_id=story_id %}" id="rating-form">
                                {% csrf_token %}
                                <div class="star-rating" id="star-selector">
                                    <span class="star" data-value="1">&#9733;</span>
                                    <span class="star" data-value="2">&#9733;</span>
                                    <span class="star" data-value="3">&#9733;</span>
                                    <span class="star" data-value="4">&#9733;</span>
                                    <span class="star" data-value="5">&#9733;</span>
                                </div>
                                {{ user_rating_form.rating }}
                                <div class="comment-area">
                                    {{ user_rating_form.comment }}
                                </div>
                                <button type="submit" class="btn">Submit Rating</button>
                            </form>
                        </div>
                    {% else %}
                        <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to leave a rating and comment.</p>
                    {% endif %}

                    <div class="existing-comments">
                        <h4>What others said:</h4>
                        {% for item in ratings_comments %}
                            <div class="comment-item">
                                <div class="comment-header">
                                    <strong>{{ item.user.username }}</strong>
                                    <span class="stars-display">
                                        {% for i in "12345" %}
                                            <span class="{% if forloop.counter <= item.rating %}filled{% endif %}">&#9733;</span>
                                        {% endfor %}
                                    </span>
                                    <small>{{ item.created_at|date:"F j, Y" }}</small>
                                </div>
                                <div class="comment-text">
                                    {{ item.comment }}
                                </div>
                            </div>
                        {% empty %}
                            <p>No comments yet. Be the first to share your thoughts!</p>
                        {% endfor %}
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const stars = document.querySelectorAll('#star-selector .star');
                        const ratingInput = document.querySelector('input[name="rating"]');
                        let currentRating = parseInt(ratingInput.value) || 0;

                        function updateStars(val, type) {
                            stars.forEach(s => {
                                const starVal = parseInt(s.getAttribute('data-value'));
                                if (type === 'hover') {
                                    s.classList.toggle('hover', starVal <= val);
                                } else if (type === 'select') {
                                    s.classList.toggle('selected', starVal <= val);
                                }
                            });
                        }

                        if (currentRating > 0) {
                            updateStars(currentRating, 'select');
                        }

                        stars.forEach(star => {
                            star.addEventListener('mouseover', () => updateStars(parseInt(star.getAttribute('data-value')), 'hover'));
                            star.addEventListener('mouseout', () => updateStars(0, 'hover'));
                            star.addEventListener('click', () => {
                                currentRating = parseInt(star.getAttribute('data-value'));
                                ratingInput.value = currentRating;
                                updateStars(currentRating, 'select');
                            });
                        });
                    });
                </script>

            {% else %}

                {% if node.text and node.type != 'dialogue' and not node.content %}
                    <div class="story-text">
                        {{ node.text }}
                    </div>
                {% endif %}

                {% if node.dialogue %}
                    {% for line in node.dialogue %}
                        <div class="dialogue-box">
                            {% if line.speaker %}<strong>{{ line.speaker }}:</strong>{% endif %}
                            {{ line.text }}
                        </div>
                    {% endfor %}
                {% endif %}

                {% for line in node.content %}
                    <div class="dialogue-box">
                        {% if line.speaker %}<strong>{{ line.speaker }}:</strong>{% endif %}
                        {{ line.text }}
                    </div>
                {% endfor %}

                <hr class="divider">

                <div class="choices">
                    <h3>What do you want to do?</h3>
                    {% for choice in node.choices %}
                        {% if choice.id %}
                            <form method="post" action="{% url 'choose_choice' story_id=story_id node_id=node.id %}" class="choice-form">
                                {% csrf_token %}
                                <input type="hidden" name="choice_id" value="{{ choice.id }}">
                                <button type="submit" class="choice-btn">
                                    <div>{{ choice.label }}</div>
                                    {% if choice.requires_roll %}
                                        <span class="choice-roll">Dice 1d{{ choice.roll_sides|default:6 }} >= {{ choice.roll_required|default:4 }}</span>
                                    {% endif %}
                                </button>
                            </form>
                        {% else %}
                            <a href="{% url 'play_node' story_id=story_id node_id=choice.target_node %}" class="choice-btn">
                                {{ choice.label }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>

            {% endif %}
        </div>
    </div>
</body>
</html>
