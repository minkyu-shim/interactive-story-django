{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
<title>NAHB - Edit Story: {{ story.title }}</title>
    <link rel="stylesheet" href="{% static 'gameplay/css/app.css' %}">
    <link rel="stylesheet" href="{% static 'gameplay/css/theme.css' %}">
    <script src="{% static 'gameplay/js/theme.js' %}"></script>
</head>
<body class="app-body story-edit-page">
    <div class="page-wrap">
        <div class="page-card">
            <div class="flex-between">
                <h1 class="section-title">Story Builder</h1>
                <div class="action-group">
                    <a href="{% url 'story_graph' story.id %}" class="btn btn-secondary">Tree View</a>
                    <a href="{% url 'story_list' %}" class="btn btn-ghost">&larr; Exit Editor</a>
                </div>
            </div>

            <div class="section">
                <form method="post" id="story-info-form">
                    {% csrf_token %}
                    <div class="form-grid-2">
                        <div>
                            <label for="story-title">Story Title</label>
                            <input id="story-title" type="text" name="title" value="{{ story.title }}" class="text-input" required>
                        </div>
                        <div>
                            <label for="story-status">Status</label>
                            <select id="story-status" name="status" class="select-input">
                                <option value="draft" {% if story.status == 'draft' %}selected{% endif %}>Draft</option>
                                <option value="published" {% if story.status == 'published' %}selected{% endif %}>Published</option>
                                <option value="suspended" {% if story.status == 'suspended' %}selected{% endif %}>Suspended</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="story-description">Description</label>
                        <textarea id="story-description" name="description" rows="2" class="text-area" required>{{ story.description }}</textarea>
                    </div>
                    <button type="submit" class="btn" id="save-story-btn">Save Story Info</button>
                </form>
            </div>

            <div class="section">
                <div class="flex-between">
                    <h2 class="section-title">Adventure Nodes (Pages)</h2>
                    <div class="action-group">
                        <a href="{% url 'story_graph' story.id %}" class="btn btn-secondary">Open Graph</a>
                        <a href="{% url 'add_page' story.id %}" class="btn btn-success">+ Add New Node</a>
                    </div>
                </div>

                {% for page in story.pages %}
                    <div class="page-item">
                        <div class="page-header">
                            <div>
                                <strong>#{{ page.id|default:"Unknown" }}</strong>
                                {% if forloop.first %}<span class="start-badge">START NODE</span>{% endif %}
                                {% if page.is_ending %}
                                    <span class="ending-badge">ENDING: {{ page.ending_label|default:"The End" }}</span>
                                {% endif %}
                            </div>
                            <div class="action-group">
                                {% if page.id %}
                                    <a href="{% url 'edit_page' story.id page.id %}" class="btn btn-sm btn-secondary">Edit</a>
                                    <form action="{% url 'delete_page' story.id page.id %}" method="post" class="tight-form" onsubmit="return confirm('Delete this page and all its choices?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>

                        <p class="page-preview">"{{ page.text|truncatewords:50 }}"</p>

                        <div class="choice-block">
                            <div class="choice-header">
                                <span class="choice-label">PLAYER CHOICES</span>
                                {% if not page.is_ending and page.id %}
                                    <a href="{% url 'add_choice' story.id page.id %}" class="btn btn-sm btn-ghost">+ Add Choice</a>
                                {% endif %}
                            </div>

                            {% for choice in page.choices %}
                                <div class="choice-item">
                                    <span class="choice-main">
                                        <strong class="choice-text">"{{ choice.text }}"</strong>
                                        <span class="choice-arrow">&rarr;</span>
                                        <span class="choice-target">Leads to Node #{{ choice.next_page_id }}</span>
                                        {% if choice.requires_roll %}
                                            <span class="roll-pill">Dice 1d{{ choice.roll_sides|default:6 }} >= {{ choice.roll_required|default:4 }}</span>
                                        {% endif %}
                                    </span>
                                    <div class="action-group">
                                        {% if page.id %}
                                            <a href="{% url 'edit_choice' story.id page.id choice.id %}" class="btn btn-sm btn-ghost">Edit</a>
                                        {% endif %}
                                        <form action="{% url 'delete_choice' story.id choice.id %}" method="post" class="tight-form" onsubmit="return confirm('Remove this choice?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-ghost btn-danger-text">&times;</button>
                                        </form>
                                    </div>
                                </div>
                            {% empty %}
                                {% if not page.is_ending %}
                                    <p class="no-choice">No choices yet. This node is currently a dead end.</p>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>Your adventure is empty. Start by creating the first scene!</p>
                        <a href="{% url 'add_page' story.id %}" class="btn btn-success">Create the First Node</a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        (function () {
            var form = document.getElementById('story-info-form');
            var submitBtn = document.getElementById('save-story-btn');
            if (!form || !submitBtn) {
                return;
            }
            form.addEventListener('submit', function () {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            });
        })();
    </script>
</body>
</html>
