{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
<title>NAHB - Story List</title>
    <link rel="stylesheet" href="{% static 'gameplay/css/app.css' %}">
    <link rel="stylesheet" href="{% static 'gameplay/css/theme.css' %}">
    <script src="{% static 'gameplay/js/theme.js' %}"></script>
</head>
<body class="app-body story-list-page">
    <div class="page-wrap">
        <div class="top-auth-bar">
            {% if user.is_authenticated %}
                <span>Welcome, <strong>{{ user.username }}</strong></span>
                <form action="{% url 'logout' %}" method="post" class="tight-form">
                    {% csrf_token %}
                    <button type="submit" class="btn-linkish">Logout</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" class="inline-link-primary">Login</a>
                <a href="{% url 'signup' %}" class="inline-link-primary">Sign Up</a>
            {% endif %}
        </div>

        <div class="page-card">
            <h1 class="page-title">{% if view_mode == 'author' %}Author Dashboard{% else %}Available Stories{% endif %}</h1>

            <div class="search-panel">
                <form method="get" action="." class="search-form">
                    <input
                        type="text"
                        name="search"
                        placeholder="Search by title..."
                        value="{{ search_query }}"
                        class="text-input search-input"
                    >

                    {% if view_mode == 'author' %}
                    <select name="status" class="select-input">
                        <option value="" {% if status_filter == '' %}selected{% endif %}>All Status</option>
                        <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
                        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Drafts</option>
                        <option value="suspended" {% if status_filter == 'suspended' %}selected{% endif %}>Suspended</option>
                    </select>
                    {% endif %}

                    <button type="submit" class="btn">Search</button>
                    <a href="." class="btn btn-light">Reset</a>
                </form>
            </div>

            <div class="toolbar-links">
                {% if view_mode == 'author' %}
                    <a href="{% url 'create_story' %}" class="btn">+ Create New Story</a>
                    <a href="{% url 'story_list' %}" class="btn btn-secondary">Switch to Reader View</a>
                {% else %}
                    <a href="{% url 'author_dashboard' %}" class="btn btn-secondary">Author Tools</a>
                {% endif %}
                <a href="{% url 'global_stats' %}" class="btn btn-secondary">View Global Stats</a>
                {% if user.is_staff %}
                    <a href="{% url 'moderation_reports' %}" class="btn btn-secondary">Moderate Reports</a>
                {% endif %}
            </div>

            <ul class="story-list">
                {% for story in stories %}
                    <li class="story-item">
                        <h2 class="story-title">{{ story.title }}</h2>
                        {% if view_mode == 'author' %}
                            <span class="status-chip {% if story.status == 'published' %}is-published{% elif story.status == 'draft' %}is-draft{% else %}is-suspended{% endif %}">
                                {{ story.status|upper }}
                            </span>
                        {% endif %}

                        <p class="story-description">{{ story.description }}</p>

                        <div class="rating-row">
                            <span class="rating-pill">
                                {% if story.avg_rating > 0 %}
                                    <span class="rating-icon">&#9733;</span>{{ story.avg_rating }}
                                {% else %}
                                    <span class="rating-icon empty">&#9734;</span>New
                                {% endif %}
                            </span>
                            {% if story.rating_count > 0 %}
                                <span class="review-count">({{ story.rating_count }} review{{ story.rating_count|pluralize }})</span>
                            {% endif %}
                        </div>

                        <div class="story-actions">
                            {% if story.resume_node %}
                                <a href="{% url 'play_node' story.id story.resume_node %}" class="btn btn-success">Resume</a>
                                <a href="{% url 'start_story' story.id %}" class="btn">Restart</a>
                            {% else %}
                                <a href="{% url 'start_story' story.id %}" class="btn">Play</a>
                            {% endif %}

                            {% if user.is_authenticated %}
                                <a href="{% url 'report_story' story.id %}" class="btn btn-warning">Report</a>
                            {% endif %}

                            {% if view_mode == 'author' %}
                                <a href="{% url 'edit_story' story.id %}" class="btn btn-secondary">Edit</a>
                                <a href="{% url 'delete_story' story.id %}" class="btn btn-danger">Delete</a>
                            {% endif %}
                        </div>
                    </li>
                {% empty %}
                    <li class="empty-message">No stories found.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</body>
</html>
